var ec = [
    {
        "EC0": 0,
        "EC1": 1,
        "EC2": 0.166848852,
        "EC3": 0,
        "EC4": 0.738776602
    },
    {
        "EC0": 0,
        "EC1": 1,
        "EC2": 0.005435754,
        "EC3": 0.026520284,
        "EC4": 0.449972301
    },
    {
        "EC0": 0.712562904,
        "EC1": 0,
        "EC2": 0.343984354,
        "EC3": 0.022726439,
        "EC4": 0.571844829
    },
    {
        "EC0": 1,
        "EC1": 0,
        "EC2": 0.82059431,
        "EC3": 0.017232048,
        "EC4": 0.677360807
    },
    {
        "EC0": 1,
        "EC1": 0,
        "EC2": 1,
        "EC3": 0.376074679,
        "EC4": 0.660507779
    },
    {
        "EC0": 1,
        "EC1": 0,
        "EC2": 1,
        "EC3": 0.249689428,
        "EC4": 1
    },
    {
        "EC0": 0,
        "EC1": 1,
        "EC2": 1,
        "EC3": 0,
        "EC4": 0.144871571
    },
    {
        "EC0": 0,
        "EC1": 1,
        "EC2": 1,
        "EC3": 0.46689947,
        "EC4": 0
    },
    {
        "EC0": 0,
        "EC1": 1,
        "EC2": 1,
        "EC3": 0,
        "EC4": 0
    }
];

var am = [
    {
        "AM0": 0.019387249,
        "AM1": 0.837617666,
        "AM2": 0.248786427,
        "AM3": 0.075
    },
    {
        "AM0": 0.770530136,
        "AM1": 0.633323301,
        "AM2": 1,
        "AM3": 0.866666667
    },
    {
        "AM0": 0.948502903,
        "AM1": 0.80890862,
        "AM2": 1,
        "AM3": 0
    },
    {
        "AM0": 0.862193675,
        "AM1": 0.977011441,
        "AM2": 0.437964446,
        "AM3": 0.525
    },
    {
        "AM0": 0.672831673,
        "AM1": 0.955209717,
        "AM2": 1,
        "AM3": 0.691666667
    },
    {
        "AM0": 0.793983124,
        "AM1": 0.95823687,
        "AM2": 0.719942126,
        "AM3": 0.266666667
    },
    {
        "AM0": 0.839804308,
        "AM1": 1,
        "AM2": 0.563826896,
        "AM3": 0
    },
    {
        "AM0": 0.746700626,
        "AM1": 1,
        "AM2": 0.306782647,
        "AM3": 0.041666667
    },
    {
        "AM0": 0.88424892,
        "AM1": 1,
        "AM2": 0.82442125,
        "AM3": 0.575
    }
];

var bp = [
    {
        "BP0": 0.980488598,
        "BP1": 1,
        "BP2": 0.678351404,
        "BP3": 0.389656394,
        "BP4": 1
    },
    {
        "BP0": 0.861618463,
        "BP1": 1,
        "BP2": 1,
        "BP3": 0,
        "BP4": 0.741895976
    },
    {
        "BP0": 0.886428084,
        "BP1": 0.778103144,
        "BP2": 1,
        "BP3": 0,
        "BP4": 0.939732709
    },
    {
        "BP0": 0.868362243,
        "BP1": 0.59173156,
        "BP2": 0.838101291,
        "BP3": 0.515925556,
        "BP4": 1
    },
    {
        "BP0": 0.789091392,
        "BP1": 0.379934335,
        "BP2": 0.222246955,
        "BP3": 0.832011189,
        "BP4": 0.461827023
    },
    {
        "BP0": 0.894995814,
        "BP1": 0.745414466,
        "BP2": 0,
        "BP3": 1,
        "BP4": 0.634540736
    },
    {
        "BP0": 0.812379381,
        "BP1": 1,
        "BP2": 0,
        "BP3": 1,
        "BP4": 0.89775923
    },
    {
        "BP0": 0.971203605,
        "BP1": 1,
        "BP2": 0,
        "BP3": 1,
        "BP4": 0.26037243
    },
    {
        "BP0": 0.928501805,
        "BP1": 0.799924322,
        "BP2": 0.22970351,
        "BP3": 0.797234339,
        "BP4": 0.289970358
    }
];

var sc = [
    {
        "SC0": 0,
        "SC1": 0.016469023,
        "SC2": 0.619455376
    },
    {
        "SC0": 0.440245658,
        "SC1": 0.28894949,
        "SC2": 0.30700837
    },
    {
        "SC0": 0.63500143,
        "SC1": 0.441059832,
        "SC2": 0.457723345
    },
    {
        "SC0": 1,
        "SC1": 0.158944172,
        "SC2": 1
    },
    {
        "SC0": 0.585611897,
        "SC1": 0.784241618,
        "SC2": 1
    },
    {
        "SC0": 0.938576136,
        "SC1": 0.900227496,
        "SC2": 1
    },
    {
        "SC0": 1,
        "SC1": 0.817007082,
        "SC2": 0.980655174
    },
    {
        "SC0": 1,
        "SC1": 0,
        "SC2": 0.905643515
    },
    {
        "SC0": 1,
        "SC1": 0,
        "SC2": 1
    }
];

var ins = [
    {
        "IN0": 1,
        "IN1": 1,
        "IN2": 0.924444444
    },
    {
        "IN0": 1,
        "IN1": 1,
        "IN2": 0.924444444
    },
    {
        "IN0": 1,
        "IN1": 1,
        "IN2": 0.924444444
    },
    {
        "IN0": 1,
        "IN1": 0.5,
        "IN2": 0.924444444
    },
    {
        "IN0": 1,
        "IN1": 0.5,
        "IN2": 0.924444444
    },
    {
        "IN0": 1,
        "IN1": 0.5,
        "IN2": 0.924444444
    },
    {
        "IN0": 1,
        "IN1": 0.5,
        "IN2": 0.924444444
    },
    {
        "IN0": 1,
        "IN1": 0.5,
        "IN2": 0.924444444
    },
    {
        "IN0": 1,
        "IN1": 0.5,
        "IN2": 0.924444444
    }
];

var info = [
    {
        "Years": "2009-01-01",
        "EC": 0.375327234,
        "AM": 0.307757138,
        "BP": 0.809699279,
        "SC": 0.232182604,
        "IN": 0.492658519,
        "PROM": 0.443524955
    },
    {
        "Years": "2010-01-01",
        "EC": 0.291792803,
        "AM": 0.825552883,
        "BP": 0.720702888,
        "SC": 0.345673589,
        "IN": 0.329514486,
        "PROM": 0.50264733
    },
    {
        "Years": "2011-01-01",
        "EC": 0.321779208,
        "AM": 0.680264935,
        "BP": 0.720852787,
        "SC": 0.511393774,
        "IN": 0.329514486,
        "PROM": 0.512761038
    },
    {
        "Years": "2012-01-01",
        "EC": 0.487666994,
        "AM": 0.683467282,
        "BP": 0.76282413,
        "SC": 0.745939924,
        "IN": 0.329514486,
        "PROM": 0.601882563
    },
    {
        "Years": "2013-01-01",
        "EC": 0.59855477,
        "AM": 0.842504897,
        "BP": 0.537022179,
        "SC": 0.797604419,
        "IN": 0.329514486,
        "PROM": 0.62104015
    },
    {
        "Years": "2014-01-01",
        "EC": 0.639195639,
        "AM": 0.677523512,
        "BP": 0.654990203,
        "SC": 0.949521489,
        "IN": 0.972265514,
        "PROM": 0.778699272
    },
    {
        "Years": "2015-01-01",
        "EC": 0.414566764,
        "AM": 0.583672832,
        "BP": 0.742027722,
        "SC": 0.937627402,
        "IN": 0.972265514,
        "PROM": 0.730032047
    },
    {
        "Years": "2016-01-01",
        "EC": 0.48921907,
        "AM": 0.503023922,
        "BP": 0.646315207,
        "SC": 0.663318548,
        "IN": 0.972265514,
        "PROM": 0.654828452
    },
    {
        "Years": "2017-01-01",
        "EC": 0.385209779,
        "AM": 0.816262075,
        "BP": 0.609066867,
        "SC": 0.697927216,
        "IN": 0.804930887,
        "PROM": 0.662679365
    }
];

var ecpond = {
    "EC0": 0.2,
    "EC1": 0.2,
    "EC2": 0.2,
    "EC3": 0.2,
    "EC4": 0.2
};
var ampond = {
    "AM0": 0.25,
    "AM1": 0.25,
    "AM2": 0.25,
    "AM3": 0.25
};
var bppond = {
    "BP0": 0.20,
    "BP1": 0.20,
    "BP2": 0.20,
    "BP3": 0.20,
    "BP4": 0.20
};
var scpond = {
    "SC0": 0.333333333,
    "SC1": 0.333333333,
    "SC2": 0.333333333
};
var inpond = {
    "IN0": 0.333333333,
    "IN1": 0.333333333,
    "IN2": 0.333333333
};

var pond = {
    "EC": 0.2,
    "AM": 0.2,
    "BP": 0.2,
    "SC": 0.2,
    "IN": 0.2
};

// Themes begin
am4core.useTheme(am4themes_animated);
// Themes end

var chart = am4core.create("CHART", am4charts.XYChart);
chart.data = info;
var xAxis = chart.xAxes.push(new am4charts.DateAxis());
xAxis.dataFields.category = "Years";
xAxis.renderer.grid.template.location = 0;
xAxis.renderer.grid.template.location = 0;
xAxis.renderer.minGridDistance = 1;
xAxis.renderer.labels.template.horizontalCenter = "right";
xAxis.renderer.labels.template.verticalCenter = "middle";
xAxis.renderer.labels.template.rotation = 270;
xAxis.renderer.maxHeight = 40;

var yAxis = chart.yAxes.push(new am4charts.ValueAxis());
var gradient1 = new am4core.LinearGradient();
gradient1.addColor(am4core.color("red"));
gradient1.addColor(am4core.color("green"));
gradient1.rotation = 270;
var range = yAxis.axisRanges.create();
range.value = 0;
range.endValue = 1;
range.axisFill.fill = gradient1;
range.axisFill.fillOpacity = 0.3;
range.label.disabled = true;
yAxis.min = 0;
yAxis.max = 1;
yAxis.strictMinMax = true;

// Create series
var ECseries = addSeries(chart, "EC", "yellow", 2, "Económica");
var AMseries = addSeries(chart, "AM", "green", 2, "Ambiental");
var BPseries = addSeries(chart, "BP", "blue", 2, "Biopesquera");
var SCseries = addSeries(chart, "SC", "red", 2, "Sociocultural");
var INseries = addSeries(chart, "IN", "gray", 2, "Institucional");
var PROMseries = addSeries(chart, "PROM", "black", 5, "Global");

var POLARchart = am4core.create("POLAR", am4charts.RadarChart);

var polarData = [{
    "dim": "Económica",
    "logro": 0.385209779
}, {
    "dim": "Ambiental",
    "logro": 0.816262075
}, {
    "dim": "Biopesquera",
    "logro": 0.609066867
}, {
    "dim": "Sociocultural",
    "logro": 0.697927216
}, {
    "dim": "Institucional",
    "logro": 0.804930887
}];

/* Add data */
POLARchart.data = polarData;

/* Create axes */
var POLARcategoryAxis = POLARchart.xAxes.push(new am4charts.CategoryAxis());
POLARcategoryAxis.dataFields.category = "dim";

var POLARvalueAxis = POLARchart.yAxes.push(new am4charts.ValueAxis());
POLARvalueAxis.renderer.axisFills.template.fill = POLARchart.colors.getIndex(2);
POLARvalueAxis.renderer.axisFills.template.fillOpacity = 0.05;
POLARvalueAxis.renderer.gridType = "polygons";
/* Create and configure series */
var POLARseries = POLARchart.series.push(new am4charts.RadarSeries());
POLARseries.dataFields.valueY = "logro";
POLARseries.dataFields.categoryX = "dim";
POLARseries.name = "polar";
POLARseries.strokeWidth = 3;
POLARseries.stroke = am4core.color("black");
var POLARgradient1 = new am4core.RadialGradient();
POLARgradient1.addColor(am4core.color("red"));
POLARgradient1.addColor(am4core.color("green"));
var POLARrange = POLARvalueAxis.axisRanges.create();
POLARrange.value = 0;
POLARrange.endValue = 1;
POLARrange.axisFill.fill = POLARgradient1;
POLARrange.axisFill.fillOpacity = 0.7;
POLARrange.label.disabled = true;

// Add cursor
chart.cursor = new am4charts.XYCursor();
chart.cursor.behavior = "zoomXY";

var i = 8;

var ECgauge = startGauge("EC", i);
var AMgauge = startGauge("AM", i);
var BPgauge = startGauge("BP", i);
var SCgauge = startGauge("SC", i);
var INgauge = startGauge("IN", i);

var PROMgauge = gauge("PROM");
setProm(0.605871421);

startHandle("EC");
startHandle("AM");
startHandle("BP");
startHandle("SC");
startHandle("IN");

startHandleEC("EC0");
startHandleEC("EC1");
startHandleEC("EC2");
startHandleEC("EC3");
startHandleEC("EC4");

startHandleAM("AM0");
startHandleAM("AM1");
startHandleAM("AM2");
startHandleAM("AM3");

startHandleBP("BP0");
startHandleBP("BP1");
startHandleBP("BP2");
startHandleBP("BP3");
startHandleBP("BP4");

startHandleSC("SC0");
startHandleSC("SC1");
startHandleSC("SC2");

startHandleIN("IN0");
startHandleIN("IN1");
startHandleIN("IN2");

startYR();

function control(panel) {
    $(".panel").addClass("d-none");
    $("#" + panel + "panel").removeClass("d-none");
}

function startYR() {
    var handle = $("#YR-handle");
    handle.parent().slider({
        min: 2009,
        max: 2017,
        range: "min",
        create: function () {
            handle.text("2017");
            handle.parent().slider('value', 2017);
        },
        slide: function (_e, ui) {
            handle.text(ui.value);
            changeYear(ui.value);
        }
    });
}

var tmp;

function startHandle(key) {
    var pre = "#" + key + "-";
    var id = pre + "handle";
    var value = pre + "value";
    var handle = $(id);
    var val = pond[key] * 100;
    val = val.toFixed(0);
    handle.parent().slider({
        step: 1,
        range: "min",
        value: val,
        create: function () {
            handle.text(val + "%");
            $(value).val(val);
        },
        slide: function (_e, ui) {
            var sorted = $(".gslider:not(#" + key + "-slider)").sort(function (a, b) {
                return $(a).slider('value') - $(b).slider('value');
            });
            if (ui.value === 100) {
                $(sorted).each(function () {
                    $(this).slider('value', 0);
                    $(this).children(":first").text("0%");
                });
                $(value).val(100);
                handle.text("100%");
                $.each(chart.data, function (i, j) {
                    chart.data[i]["PROM"] = j[key];
                });
            } else if (ui.value === 0) {
                $(sorted).each(function () {
                    $(this).slider('value', 25);
                    $(this).children(":first").text("25%");
                });
                $.each(pond, function (i, _e) { pond[i] = 0.25; });
                pond[key] = 0;
                $(value).val(0);
                handle.text("0%");
                $.each(chart.data, function (i, j) {
                    chart.data[i]["PROM"] = j["EC"] * pond["EC"] + j["AM"] * pond["AM"] + j["BP"] * pond["BP"] + j["SC"] * pond["SC"] + j["IN"] * pond["IN"];
                });
            } else {
                var sum = 0;
                $(sorted).each(function () {
                    var va = $(this).slider('value');
                    sum += va;
                    var dim = this.id.slice(0, 2);
                    pond[dim] = va / 100;
                });
                pond[key] = ui.value / 100;
                var index = $(value).val() > ui.value ? 0 : sorted.length - 1;
                $(value).val(ui.value);
                handle.text(ui.value + "%");
                var dif = 100 - ui.value - sum;
                var nu = $(sorted[index]).slider('value') + dif;
                if (nu >= 0) {
                    $(sorted[index]).slider('value', nu);
                    $(sorted[index]).children(":first").text(nu + "%");
                    pond[sorted[index].id.slice(0, 2)] = nu / 100;
                } else {
                    $(sorted[index]).slider('value', 0);
                    $(sorted[index]).children(":first").text("0%");
                    pond[sorted[index].id.slice(0, 2)] = 0;
                    ui.value += nu;
                }
                $.each(chart.data, function (i, j) {
                    chart.data[i]["PROM"] = j["EC"] * pond["EC"] + j["AM"] * pond["AM"] + j["BP"] * pond["BP"] + j["SC"] * pond["SC"] + j["IN"] * pond["IN"];
                });
            }
            chart.invalidateData();
            setProm(chart.data[$("#YR-handle").text() - 2009]["PROM"]);
        }
    });
}

function startHandleEC(key) {
    var pre = "#" + key + "-";
    var id = pre + "handle";
    var value = pre + "value";
    var handle = $(id);
    var val = ecpond[key] * 100;
    val = val.toFixed(0);
    handle.parent().slider({
        step: 1,
        range: "min",
        value: val,
        create: function () {
            handle.text(val + "%");
            $(value).val(val);
        },
        slide: function (_e, ui) {
            var sorted = $(".ecslider:not(#" + key + "-slider)").sort(function (a, b) {
                return $(a).slider('value') - $(b).slider('value');
            });
            if (ui.value === 100) {
                $(sorted).each(function () {
                    $(this).slider('value', 0);
                    $(this).children(":first").text("0%");
                });
                $(value).val(100);
                handle.text("100%");
                $.each(chart.data, function (i, _j) {
                    chart.data[i]["EC"] = ec[i][key];
                });
            } else if (ui.value === 0) {
                $(sorted).each(function () {
                    $(this).slider('value', 25);
                    $(this).children(":first").text("25%");
                });
                $.each(ecpond, function (i, _e) { ecpond[i] = 0.25; });
                ecpond[key] = 0;
                $(value).val(0);
                handle.text("0%");
                $.each(chart.data, function (i, j) {
                    chart.data[i]["EC"] = ec[i]["EC0"] * ecpond["EC0"]
                        + ec[i]["EC1"] * ecpond["EC1"]
                        + ec[i]["EC2"] * ecpond["EC2"]
                        + ec[i]["EC3"] * ecpond["EC3"]
                        + ec[i]["EC4"] * ecpond["EC4"];
                });
            } else {
                var sum = 0;
                $(sorted).each(function () {
                    var va = $(this).slider('value');
                    sum += va;
                    var dim = this.id.slice(0, 3);
                    ecpond[dim] = va / 100;
                });
                ecpond[key] = ui.value / 100;
                var index = $(value).val() > ui.value ? 0 : sorted.length - 1;
                $(value).val(ui.value);
                handle.text(ui.value + "%");
                var dif = 100 - ui.value - sum;
                var nu = $(sorted[index]).slider('value') + dif;
                if (nu >= 0) {
                    $(sorted[index]).slider('value', nu);
                    $(sorted[index]).children(":first").text(nu + "%");
                    ecpond[sorted[index].id.slice(0, 3)] = nu / 100;
                } else {
                    $(sorted[index]).slider('value', 0);
                    $(sorted[index]).children(":first").text("0%");
                    ecpond[sorted[index].id.slice(0, 3)] = 0;
                    ui.value += nu;
                }
                $.each(chart.data, function (i, j) {
                    chart.data[i]["EC"] = ec[i]["EC0"] * ecpond["EC0"]
                        + ec[i]["EC1"] * ecpond["EC1"]
                        + ec[i]["EC2"] * ecpond["EC2"]
                        + ec[i]["EC3"] * ecpond["EC3"]
                        + ec[i]["EC4"] * ecpond["EC4"];
                });
            }
            $.each(chart.data, function (i, j) {
                chart.data[i]["PROM"] = j["EC"] * pond["EC"] + j["AM"] * pond["AM"] + j["BP"] * pond["BP"] + j["SC"] * pond["SC"] + j["IN"] * pond["IN"];
            });

            chart.invalidateData();
            var idx = $("#YR-handle").text() - 2009;
            setProm(chart.data[idx]["PROM"]);
            setValue(ECgauge, chart.data[idx]["EC"]);
        }
    });
}

function startHandleAM(key) {
    var pre = "#" + key + "-";
    var id = pre + "handle";
    var value = pre + "value";
    var handle = $(id);
    var val = ampond[key] * 100;
    val = val.toFixed(0);
    handle.parent().slider({
        step: 1,
        range: "min",
        value: val,
        create: function () {
            handle.text(val + "%");
            $(value).val(val);
        },
        slide: function (_e, ui) {
            var sorted = $(".amslider:not(#" + key + "-slider)").sort(function (a, b) {
                return $(a).slider('value') - $(b).slider('value');
            });
            if (ui.value === 100) {
                $(sorted).each(function () {
                    $(this).slider('value', 0);
                    $(this).children(":first").text("0%");
                });
                $(value).val(100);
                handle.text("100%");
                $.each(chart.data, function (i, _j) {
                    chart.data[i]["AM"] = am[i][key];
                });
            } else if (ui.value === 0) {
                $(sorted).each(function () {
                    $(this).slider('value', 33);
                    $(this).children(":first").text("33%");
                });
                $.each(ampond, function (i, _e) { ampond[i] = 0.333333333; });
                ampond[key] = 0;
                $(value).val(0);
                handle.text("0%");
                $.each(chart.data, function (i, j) {
                    chart.data[i]["AM"] = am[i]["AM0"] * ampond["AM0"]
                        + am[i]["AM1"] * ampond["AM1"]
                        + am[i]["AM2"] * ampond["AM2"]
                        + am[i]["AM3"] * ampond["AM3"];
                });
            } else {
                var sum = 0;
                $(sorted).each(function () {
                    var va = $(this).slider('value');
                    sum += va;
                    var dim = this.id.slice(0, 3);
                    ampond[dim] = va / 100;
                });
                ampond[key] = ui.value / 100;
                var index = $(value).val() > ui.value ? 0 : sorted.length - 1;
                $(value).val(ui.value);
                handle.text(ui.value + "%");
                var dif = 100 - ui.value - sum;
                var nu = $(sorted[index]).slider('value') + dif;
                if (nu >= 0) {
                    $(sorted[index]).slider('value', nu);
                    $(sorted[index]).children(":first").text(nu + "%");
                    ampond[sorted[index].id.slice(0, 3)] = nu / 100;
                } else {
                    $(sorted[index]).slider('value', 0);
                    $(sorted[index]).children(":first").text("0%");
                    ampond[sorted[index].id.slice(0, 3)] = 0;
                    ui.value += nu;
                }
                $.each(chart.data, function (i, j) {
                    chart.data[i]["AM"] = am[i]["AM0"] * ampond["AM0"]
                        + am[i]["AM1"] * ampond["AM1"]
                        + am[i]["AM2"] * ampond["AM2"]
                        + am[i]["AM3"] * ampond["AM3"];
                });
            }
            $.each(chart.data, function (i, j) {
                chart.data[i]["PROM"] = j["EC"] * pond["EC"] + j["AM"] * pond["AM"] + j["BP"] * pond["BP"] + j["SC"] * pond["SC"] + j["IN"] * pond["IN"];
            });

            chart.invalidateData();
            var idx = $("#YR-handle").text() - 2009;
            setProm(chart.data[idx]["PROM"]);
            setValue(AMgauge, chart.data[idx]["AM"]);
        }
    });
}

function startHandleBP(key) {
    var pre = "#" + key + "-";
    var id = pre + "handle";
    var value = pre + "value";
    var handle = $(id);
    var val = bppond[key] * 100;
    val = val.toFixed(0);
    handle.parent().slider({
        step: 1,
        range: "min",
        value: val,
        create: function () {
            handle.text(val + "%");
            $(value).val(val);
        },
        slide: function (_e, ui) {
            var sorted = $(".bpslider:not(#" + key + "-slider)").sort(function (a, b) {
                return $(a).slider('value') - $(b).slider('value');
            });
            if (ui.value === 100) {
                $(sorted).each(function () {
                    $(this).slider('value', 0);
                    $(this).children(":first").text("0%");
                });
                $(value).val(100);
                handle.text("100%");
                $.each(chart.data, function (i, _j) {
                    chart.data[i]["BP"] = bp[i][key];
                });
            } else if (ui.value === 0) {
                $(sorted).each(function () {
                    $(this).slider('value', 25);
                    $(this).children(":first").text("25%");
                });
                $.each(bppond, function (i, _e) { bppond[i] = 0.25; });
                bppond[key] = 0;
                $(value).val(0);
                handle.text("0%");
                $.each(chart.data, function (i, j) {
                    chart.data[i]["BP"] = bp[i]["BP0"] * bppond["BP0"]
                        + bp[i]["BP1"] * bppond["BP1"]
                        + bp[i]["BP2"] * bppond["BP2"]
                        + bp[i]["BP3"] * bppond["BP3"]
                        + bp[i]["BP4"] * bppond["BP4"];
                });
            } else {
                var sum = 0;
                $(sorted).each(function () {
                    var va = $(this).slider('value');
                    sum += va;
                    var dim = this.id.slice(0, 3);
                    bppond[dim] = va / 100;
                });
                bppond[key] = ui.value / 100;
                var index = $(value).val() > ui.value ? 0 : sorted.length - 1;
                $(value).val(ui.value);
                handle.text(ui.value + "%");
                var dif = 100 - ui.value - sum;
                var nu = $(sorted[index]).slider('value') + dif;
                if (nu >= 0) {
                    $(sorted[index]).slider('value', nu);
                    $(sorted[index]).children(":first").text(nu + "%");
                    bppond[sorted[index].id.slice(0, 3)] = nu / 100;
                } else {
                    $(sorted[index]).slider('value', 0);
                    $(sorted[index]).children(":first").text("0%");
                    bppond[sorted[index].id.slice(0, 3)] = 0;
                    ui.value += nu;
                }
                $.each(chart.data, function (i, j) {
                    chart.data[i]["BP"] = bp[i]["BP0"] * bppond["BP0"]
                        + bp[i]["BP1"] * bppond["BP1"]
                        + bp[i]["BP2"] * bppond["BP2"]
                        + bp[i]["BP3"] * bppond["BP3"]
                        + bp[i]["BP4"] * bppond["BP4"];
                });
            }
            $.each(chart.data, function (i, j) {
                chart.data[i]["PROM"] = j["EC"] * pond["EC"] + j["AM"] * pond["AM"] + j["BP"] * pond["BP"] + j["SC"] * pond["SC"] + j["IN"] * pond["IN"];
            });

            chart.invalidateData();
            var idx = $("#YR-handle").text() - 2009;
            setProm(chart.data[idx]["PROM"]);
            setValue(BPgauge, chart.data[idx]["BP"]);
        }
    });
}

function startHandleSC(key) {
    var pre = "#" + key + "-";
    var id = pre + "handle";
    var value = pre + "value";
    var handle = $(id);
    var val = scpond[key] * 100;
    val = val.toFixed(0);
    handle.parent().slider({
        step: 1,
        range: "min",
        value: val,
        create: function () {
            handle.text(val + "%");
            $(value).val(val);
        },
        slide: function (_e, ui) {
            var sorted = $(".scslider:not(#" + key + "-slider)").sort(function (a, b) {
                return $(a).slider('value') - $(b).slider('value');
            });
            if (ui.value === 100) {
                $(sorted).each(function () {
                    $(this).slider('value', 0);
                    $(this).children(":first").text("0%");
                });
                $(value).val(100);
                handle.text("100%");
                $.each(chart.data, function (i, _j) {
                    chart.data[i]["SC"] = sc[i][key];
                });
            } else if (ui.value === 0) {
                $(sorted).each(function () {
                    $(this).slider('value', 50);
                    $(this).children(":first").text("50%");
                });
                $.each(scpond, function (i, _e) { scpond[i] = 0.5; });
                scpond[key] = 0;
                $(value).val(0);
                handle.text("0%");
                $.each(chart.data, function (i, j) {
                    chart.data[i]["SC"] = sc[i]["SC0"] * scpond["SC0"]
                        + sc[i]["SC1"] * scpond["SC1"]
                        + sc[i]["SC2"] * scpond["SC2"];
                });
            } else {
                var sum = 0;
                $(sorted).each(function () {
                    var va = $(this).slider('value');
                    sum += va;
                    var dim = this.id.slice(0, 3);
                    scpond[dim] = va / 100;
                });
                scpond[key] = ui.value / 100;
                var index = $(value).val() > ui.value ? 0 : sorted.length - 1;
                $(value).val(ui.value);
                handle.text(ui.value + "%");
                var dif = 100 - ui.value - sum;
                var nu = $(sorted[index]).slider('value') + dif;
                if (nu >= 0) {
                    $(sorted[index]).slider('value', nu);
                    $(sorted[index]).children(":first").text(nu + "%");
                    scpond[sorted[index].id.slice(0, 3)] = nu / 100;
                } else {
                    $(sorted[index]).slider('value', 0);
                    $(sorted[index]).children(":first").text("0%");
                    scpond[sorted[index].id.slice(0, 3)] = 0;
                    ui.value += nu;
                }
                $.each(chart.data, function (i, j) {
                    chart.data[i]["SC"] = sc[i]["SC0"] * scpond["SC0"]
                        + sc[i]["SC1"] * scpond["SC1"]
                        + sc[i]["SC2"] * scpond["SC2"];
                });
            }
            $.each(chart.data, function (i, j) {
                chart.data[i]["PROM"] = j["EC"] * pond["EC"] + j["AM"] * pond["AM"] + j["BP"] * pond["BP"] + j["SC"] * pond["SC"] + j["IN"] * pond["IN"];
            });

            chart.invalidateData();
            var idx = $("#YR-handle").text() - 2009;
            setProm(chart.data[idx]["PROM"]);
            setValue(SCgauge, chart.data[idx]["SC"]);
        }
    });
}

function startHandleIN(key) {
    var pre = "#" + key + "-";
    var id = pre + "handle";
    var value = pre + "value";
    var handle = $(id);
    var val = inpond[key] * 100;
    val = val.toFixed(0);
    handle.parent().slider({
        step: 1,
        range: "min",
        value: val,
        create: function () {
            handle.text(val + "%");
            $(value).val(val);
        },
        slide: function (_e, ui) {
            var sorted = $(".inslider:not(#" + key + "-slider)").sort(function (a, b) {
                return $(a).slider('value') - $(b).slider('value');
            });
            if (ui.value === 100) {
                $(sorted).each(function () {
                    $(this).slider('value', 0);
                    $(this).children(":first").text("0%");
                });
                $(value).val(100);
                handle.text("100%");
                $.each(chart.data, function (i, _j) {
                    chart.data[i]["IN"] = ins[i][key];
                });
            } else if (ui.value === 0) {
                $(sorted).each(function () {
                    $(this).slider('value', 50);
                    $(this).children(":first").text("50%");
                });
                $.each(inpond, function (i, _e) { inpond[i] = 0.5; });
                inpond[key] = 0;
                $(value).val(0);
                handle.text("0%");
                $.each(chart.data, function (i, j) {
                    chart.data[i]["IN"] = ins[i]["IN0"] * inpond["IN0"]
                        + ins[i]["IN1"] * inpond["IN1"]
                        + ins[i]["IN2"] * inpond["IN2"];
                });
            } else {
                var sum = 0;
                $(sorted).each(function () {
                    var va = $(this).slider('value');
                    sum += va;
                    var dim = this.id.slice(0, 3);
                    inpond[dim] = va / 100;
                });
                inpond[key] = ui.value / 100;
                var index = $(value).val() > ui.value ? 0 : sorted.length - 1;
                $(value).val(ui.value);
                handle.text(ui.value + "%");
                var dif = 100 - ui.value - sum;
                var nu = $(sorted[index]).slider('value') + dif;
                if (nu >= 0) {
                    $(sorted[index]).slider('value', nu);
                    $(sorted[index]).children(":first").text(nu + "%");
                    inpond[sorted[index].id.slice(0, 3)] = nu / 100;
                } else {
                    $(sorted[index]).slider('value', 0);
                    $(sorted[index]).children(":first").text("0%");
                    inpond[sorted[index].id.slice(0, 3)] = 0;
                    ui.value += nu;
                }
                $.each(chart.data, function (i, j) {
                    chart.data[i]["IN"] = ins[i]["IN0"] * inpond["IN0"]
                        + ins[i]["IN1"] * inpond["IN1"]
                        + ins[i]["IN2"] * inpond["IN2"];
                });
            }
            $.each(chart.data, function (i, j) {
                chart.data[i]["PROM"] = j["EC"] * pond["EC"] + j["AM"] * pond["AM"] + j["BP"] * pond["BP"] + j["SC"] * pond["SC"] + j["IN"] * pond["IN"];
            });

            chart.invalidateData();
            var idx = $("#YR-handle").text() - 2009;
            setProm(chart.data[idx]["PROM"]);
            setValue(INgauge, chart.data[idx]["IN"]);
        }
    });
}

function startGauge(key, i) {
    var g = gauge(key);
    setValue(g, info[i][key]);
    return g;
}

function addSeries(chart, value, color, w, name) {
    var series = chart.series.push(new am4charts.LineSeries());
    series.dataFields.valueY = value;
    series.dataFields.dateX = "Years";
    series.name = name;
    series.stroke = am4core.color(color);
    series.strokeWidth = w;
    series.tooltipText = "{name}: [bold]{valueY}[/]";
    series.tooltip.getFillFromObject = false;
    if (value === "EC") { series.tooltip.label.fill = am4core.color("black"); }
    series.tooltip.background.fill = am4core.color(color);
    return series;
}

function setValue(chart, value) {
    chart.hands._values[0].value = value;
}

function gauge(div) {
    var chart = am4core.create(div, am4charts.GaugeChart);
    chart.hiddenState.properties.opacity = 0; // this makes initial fade in effect

    chart.innerRadius = - 25;

    var axis = chart.xAxes.push(new am4charts.ValueAxis());
    axis.min = 0;
    axis.max = 1;
    axis.strictMinMax = true;
    axis.renderer.grid.template.stroke = new am4core.InterfaceColorSet().getFor("background");
    axis.renderer.grid.template.strokeOpacity = 0.3;

    var gradient = new am4core.LinearGradient();
    gradient.addColor(am4core.color("red"));
    gradient.addColor(am4core.color("green"));

    var range0 = axis.axisRanges.create();
    range0.value = 0;
    range0.endValue = 1;
    range0.axisFill.fillOpacity = 1;
    range0.axisFill.fill = gradient;
    range0.axisFill.zIndex = - 1;

    //chart.logo = null;
    chart.hands.push(new am4charts.ClockHand());
    return chart;
}

function changeYear(yr) {
    var i = yr - 2009;
    var prom = 0;
    var c = 0;
    $.each(pond, function (key, j) {
        // create gauges
        var g = window[key + "gauge"];
        var val = info[i][key];
        polarData[c]["logro"] = val;
        setValue(g, val);
        prom += 0.2 * val;
        changeHandle(key, 20);
        c++;
    });
    setProm(prom);
    POLARchart.invalidateData();
}

function changeHandle(key, value) {
    $("#" + key + "-slider").slider('value', value);
    $("#" + key + "-handle").text(value + "%");
}

function setProm(value) {
    setValue(PROMgauge, value);
}